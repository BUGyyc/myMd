


# LockStep


## 定点数计算

## 预测与回滚



<https://zhuanlan.zhihu.com/p/38468615>





空指令的Logic

- 延迟半个回合

```
由于玩家不需要明确的下达 idle 一个回合的指令，通常 idle 这种不操作是用超时机制自动触发的。我们一般把 idle 指令的自动执行时刻点放在上一个回合结束时刻点后延大约半个回合周期即可。这个时间点不必特别精确。假设是 50ms ，那么在收到上个回合的信息，推演出沙盘的下个步骤 50ms 后，如果从最后一个发出的指令到这一刻，这段时间内没有操作，就发出 idle 操作。

```




网络环境较差，主动减慢表现层的更新
```
当网络条件不好时，我们也可以想一些办法尽可能地让表现层平滑。例如，在下个回合的逻辑时刻点 20ms 之前再检查一次有没有收齐数据，如果没有，就减慢表现层的时间，推迟下个逻辑时刻点。玩家看起来本地的表现变慢了，但是并没有卡住。如果网络状态转好，又可以加快时钟赶上。

```



网络差的情况，乐观帧锁定？？？

```
例如，你可以做这样一个优化来解决网络不稳定的问题：让权威服务器有权利自行做无操作超时，而不必等待客户端发出超时 idle 指令。

即，如果服务器超过一段时间没有收到某个客户端发过来的指令，就认为它当前回合不操作，并打包整个回合所有玩家指令（或指令计算后的状态结果）广播；如果事后这个客户端的操作晚到，扔掉即可。这样就不会因为有人突然网络断开连接无法发出当前回合的指令，而让所有人都卡住。

```


显示层主动降低频率

```
如果网络状态不好，可能发生的情况就是当前的画面进度超出了逻辑确定帧能确保的范围，那么客户端就可以零界点快到时，开始降低渲染帧率，看起来就是在放慢动作；极端情况下让画面静止卡住等待。
```


---

<https://blog.codingnow.com/2018/08/lockstep.html>